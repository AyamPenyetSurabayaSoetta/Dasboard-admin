<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir - Ayam Penyet Surabaya</title>
    <!-- Meta tag dan link untuk PWA -->
<meta name="theme-color" content="#f59e0b" />
<link rel="manifest" href="favicon/site.webmanifest">
<link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
<link rel="icon" href="favicon/favicon.ico" sizes="any">
<link rel="icon" href="favicon/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;}
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(14px); }
        .modal-content, .sidebar { transition: transform 0.3s ease-in-out; }
        .modal-overlay, #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .receipt-content {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        .receipt-content hr {
            border-top: 1px dashed #999;
            margin: 8px 0;
        }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden opacity-0"></div>
    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full w-72 bg-white shadow-lg z-40 -translate-x-full flex flex-col">
        <div class="bg-gray-400 p-4 text-white">
            <div class="flex items-center gap-4">
                <i class="fas fa-user-circle text-5xl"></i>
                <div>
                    <h3 class="font-bold text-lg">Demo Account</h3>
                    <p class="text-sm">demo</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-500 p-2 text-white text-sm text-center">
            <span id="tanggal-kerja"></span>
        </div>
        <nav class="flex-1 overflow-y-auto text-gray-700">
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-calendar-times w-6 text-center text-lg"></i><span>Stop Tanggal Kerja</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-sync w-6 text-center text-lg"></i><span>Sinkron Data Master</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-mobile-alt w-6 text-center text-lg"></i><span>Order Online</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-user-check w-6 text-center text-lg"></i><span>Absensi</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-wallet w-6 text-center text-lg"></i><span>Kas Kecil</span></a>
            <a href="#" id="buka-nota-aktif" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-receipt w-6 text-center text-lg"></i><span>Daftar Transaksi</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-chart-pie w-6 text-center text-lg"></i><span>Laporan</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-cog w-6 text-center text-lg"></i><span>Pengaturan Aplikasi</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-life-ring w-6 text-center text-lg"></i><span>Bantuan & Langganan</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-lock w-6 text-center text-lg"></i><span>Kunci Layar</span></a>
            <a href="#" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100"><i class="fas fa-sign-out-alt w-6 text-center text-lg"></i><span>Logout</span></a>
        </nav>
        <div class="p-2 text-center text-xs text-gray-500 bg-gray-100">
            Halal POS Ver : 2.15.3.3
        </div>
    </div>
    <div id="app-container" class="max-w-md mx-auto bg-white min-h-screen flex flex-col relative pb-[168px]">
        
        <header class="bg-slate-700 text-white shadow-md sticky top-0 z-20">
            <div class="flex justify-between items-center text-sm font-medium px-4 pt-3">
                <button id="menu-btn" class="text-2xl"><i class="fas fa-bars"></i></button>
                <button id="nota-baru-btn" class="py-1">Nota Baru</button>
                <button id="nota-aktif-btn" class="flex items-center gap-2 py-1">
                    <div id="active-orders-count-badge" class="bg-amber-300 text-slate-800 text-xs font-bold w-6 h-5 rounded-md flex items-center justify-center border border-slate-600">0</div>
                    <span>Nota Aktif</span>
                </button>
                <button id="daftar-meja-btn" class="py-1">Daftar Meja</button>
            </div>
        
            <div class="mx-4 mt-2 border-t border-white/20"></div>
        
            <div class="text-center py-4">
                <h1 id="nota-baru-tengah-btn" class="font-bold text-lg flex items-center justify-center gap-2 cursor-pointer">
                    <i class="fas fa-clipboard-list"></i> <span id="nota-id">Nota Baru</span>
                </h1>
            </div>
        
            <div class="flex justify-between items-center text-sm px-4 pb-3">
                <div class="flex items-center gap-2">
                    <i class="fas fa-user"></i>
                    <span id="customer-name-display" class="font-semibold">Umum</span>
                    <span class="mx-1">|</span>
                    <i class="fas fa-chair"></i>
                    <span id="table-name-display" class="font-semibold">Tanpa Meja</span>
                </div>
                <div id="take-away-container" class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="take-away-toggle" class="hidden">
                    <i class="fas fa-box-open"></i>
                    <span id="take-away-text" class="font-semibold text-slate-300">Dine In</span>
                </div>
            </div>
        </header>

        <main class="flex-1">
            <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-200 border-b font-bold text-gray-600 text-sm">
                <div class="col-span-2">Jlh</div>
                <div class="col-span-6">Produk</div>
                <div class="col-span-4 text-right">Total</div>
            </div>
            <div id="order-items-container">
                <div id="empty-cart-msg" class="h-64 flex flex-col justify-center items-center text-gray-400">
                    <i class="fas fa-shopping-cart fa-3x"></i>
                    <p class="mt-4 font-semibold">Keranjang kosong</p>
                </div>
            </div>
        </main>
        
        <button id="add-product-btn" class="absolute bottom-[180px] right-6 w-16 h-16 bg-blue-600 rounded-full text-white shadow-lg flex items-center justify-center text-3xl hover:bg-blue-700 transition z-20">
            <i class="fas fa-plus"></i>
        </button>

        <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t z-20">
            <div class="flex justify-between items-center px-4 py-2 bg-gray-50">
                <div class="text-sm">
                    <span class="font-medium">Total Produk</span>
                    <span id="total-produk" class="font-bold ml-1">0</span>
                </div>
                <div class="text-sm flex items-center gap-2">
                    <span class="font-medium">Grand Total</span>
                    <span id="grand-total" class="font-bold text-lg">Rp 0</span>
                    <i class="fas fa-chevron-up text-gray-500"></i>
                </div>
            </div>
            <div class="grid grid-cols-5 gap-1 px-2 py-2 border-t text-center text-xs text-gray-600">
                <button class="flex flex-col items-center p-1 rounded hover:bg-gray-100"><i class="fas fa-print text-xl mb-1"></i><span>Cetak</span></button>
                <button class="flex flex-col items-center p-1 rounded hover:bg-gray-100"><i class="fas fa-edit text-xl mb-1"></i><span>Ubah Nota</span></button>
                <button class="flex flex-col items-center p-1 rounded hover:bg-gray-100"><i class="fas fa-tags text-xl mb-1"></i><span>Promo</span></button>
                <button class="flex flex-col items-center p-1 rounded hover:bg-gray-100"><i class="fas fa-columns text-xl mb-1"></i><span>Split</span></button>
                <button id="cancel-btn" class="flex flex-col items-center p-1 rounded hover:bg-gray-100 text-red-500"><i class="fas fa-times-circle text-xl mb-1"></i><span>Batal Nota</span></button>
            </div>
            <div class="flex">
                <button id="save-btn" class="w-1/2 bg-gray-600 text-white p-4 text-center font-bold uppercase hover:bg-gray-700">Simpan</button>
                <button id="pay-btn" class="w-1/2 bg-blue-600 text-white p-4 text-center font-bold uppercase hover:bg-blue-700">Bayar</button>
            </div>
        </footer>
    </div>

   <div id="table-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-[80] items-center justify-center hidden p-4">
    <div class="modal-content bg-gray-200 rounded-lg shadow-xl w-full max-w-sm flex flex-col transform scale-95 opacity-0" style="max-height: 90vh;">
        <div class="p-2 bg-white rounded-t-lg">
            <div class="grid grid-cols-2 gap-1">
                <button id="tab-daftar-meja" class="p-2 text-center font-semibold border-b-4 border-blue-600 text-blue-600">Daftar Meja</button>
                <button id="tab-denah-meja" class="p-2 text-center font-semibold text-gray-500">Denah Meja</button>
            </div>
        </div>
        
        <div id="table-list-view">
            <div class="p-3">
                <div class="grid grid-cols-3 gap-2">
                    <button class="table-list-filter-btn p-2 rounded-lg bg-white border font-semibold" data-filter="Kosong">Meja Kosong</button>
                    <button class="table-list-filter-btn p-2 rounded-lg bg-white border font-semibold" data-filter="Terisi">Meja Terisi</button>
                    <button class="table-list-filter-btn p-2 rounded-lg bg-blue-600 text-white font-semibold" data-filter="Semua">Semua</button>
                </div>
            </div>
            <div id="table-list-grid" class="flex-1 overflow-y-auto p-3 grid grid-cols-3 gap-3">
            </div>
        </div>
        
        <div id="table-layout-view" class="hidden">
            <div class="p-3">
                <div class="grid grid-cols-2 gap-2">
                    <button class="floor-filter-btn p-2 rounded-lg bg-blue-600 text-white font-semibold" data-floor="1">Lantai 1</button>
                    <button class="floor-filter-btn p-2 rounded-lg bg-white border font-semibold" data-floor="2">Lantai 2</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3">
                <div id="layout-container" class="relative w-full h-52 bg-gray-300 bg-cover bg-center rounded-lg">
            </div>
        </div>
        
<div class="p-3 bg-white border-t mt-auto rounded-b-lg flex flex-col items-center">
    <p id="total-meja-text" class="text-sm font-semibold mb-2">Total Meja: 0</p> <button id="close-table-modal-btn" class="w-full bg-gray-300 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-400">Tutup</button>
</div>
    </div>
</div>
<div id="table-order-detail-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[90] items-center justify-center hidden p-4">
    <div class="modal-content bg-gray-100 rounded-lg shadow-xl w-full max-w-sm flex flex-col transform scale-95 opacity-0" style="max-height: 90vh;">
        <div class="p-4 bg-blue-600 text-white rounded-t-lg">
            <h3 class="text-xl font-bold text-center">Detail Meja <span id="detail-meja-name"></span></h3>
        </div>
        <div id="detail-meja-content" class="p-4 flex-1 overflow-y-auto text-center">
        </div>
        <div class="grid grid-cols-2 gap-3 p-3 bg-gray-200 border-t rounded-b-lg">
            <button id="detail-meja-tambah-btn" class="py-3 font-bold bg-yellow-400 text-yellow-900 rounded-lg">Tambah Pesanan</button>
            <button id="detail-meja-bayar-btn" class="py-3 font-bold bg-green-500 text-white rounded-lg">Bayar</button>
        </div>
        <div class="p-3 pt-0 bg-gray-200">
            <button id="detail-meja-tutup-btn" class="w-full py-2 font-semibold text-gray-600">Tutup</button>
        </div>
    </div>
</div>

    <div id="new-order-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-[70] items-center justify-center hidden p-4">
        <div class="modal-content bg-gray-200 rounded-lg shadow-xl w-full max-w-sm flex flex-col transform scale-95 opacity-0" style="max-height: 90vh;">
            <div class="p-4 border-b bg-white rounded-t-lg">
                <h3 class="text-xl font-bold text-center">Detil Nota</h3>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
                <div>
                    <label class="font-semibold text-gray-700">Tipe Transaksi</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <button id="new-order-dine-in-btn" class="p-3 border rounded-lg bg-blue-600 text-white font-semibold">Dine In</button>
                        <button id="new-order-take-away-btn" class="p-3 border rounded-lg bg-white font-semibold">Take Away</button>
                    </div>
                </div>
                <div>
                    <label for="new-order-customer" class="font-semibold text-gray-700">Tamu</label>
                    <div class="relative mt-1">
                        <input type="text" id="new-order-customer" value="Umum" class="w-full p-2 border rounded-lg pr-10">
                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <label for="new-order-pax" class="font-semibold text-gray-700">Tot. Tamu</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="number" id="new-order-pax" value="1" class="w-1/2 p-2 border rounded-lg text-center">
                        <button class="pax-btn w-10 h-10 bg-white border rounded-lg font-bold text-lg" data-change="-1">-</button>
                        <button class="pax-btn w-10 h-10 bg-white border rounded-lg font-bold text-lg" data-change="1">+</button>
                    </div>
                </div>
                <div>
                    <label for="new-order-notes" class="font-semibold text-gray-700">Catatan</label>
                    <textarea id="new-order-notes" rows="2" class="w-full mt-1 p-2 border rounded-lg"></textarea>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 p-3 bg-gray-100 border-t rounded-b-lg">
                <button id="close-new-order-btn" class="py-3 font-bold bg-white border rounded-lg">Tutup</button>
                <button id="save-new-order-btn" class="py-3 font-bold bg-blue-600 text-white rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="product-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 items-start justify-center hidden p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 opacity-0 flex flex-col h-full max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Pilih Produk</h3>
                <div class="flex items-center gap-4">
                    <button id="open-charge-btn" class="flex items-center gap-2 text-sm font-semibold text-blue-600 hover:text-blue-800">
                        <i class="fas fa-calculator"></i>
                        <span>Open Charge</span>
                    </button>
                    <button id="close-product-modal-btn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                </div>
            </div>
            <div class="p-4">
                <div class="relative flex-grow mb-3">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input id="search-input" type="text" placeholder="Cari produk..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div id="category-filter-container" class="flex items-center gap-2 pb-2 overflow-x-auto"></div>
            </div>
            <div id="product-grid" class="flex-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 overflow-y-auto p-4 pt-0"></div>
            
            <div id="modal-cart-summary" class="p-4 border-t bg-gray-50">
                <div class="flex justify-between items-center mb-3 text-sm">
                    <div>
                        <span class="font-medium">Total Item: </span>
                        <span id="modal-item-count" class="font-bold">0</span>
                    </div>
                    <div>
                        <span class="font-medium">Total Harga: </span>
                        <span id="modal-total-price" class="font-bold">Rp 0</span>
                    </div>
                </div>
                <button id="confirm-add-product-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    Tambahkan ke Nota
                </button>
            </div>
        </div>
    </div>

    <div id="payment-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center hidden">
        <div id="payment-main-modal" class="modal-content bg-gray-100 rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-white rounded-t-lg">
                <h3 class="text-xl font-bold">Pembayaran</h3>
                <span id="payment-nota-id" class="text-sm font-semibold text-gray-600"></span>
            </div>
            
            <div class="p-3">
                <p class="text-sm font-semibold mb-2 text-gray-600">Tipe Pembayaran</p>
                <div class="grid grid-cols-3 gap-2">
                    <button data-method="CASH" class="payment-method-btn flex-1 p-3 border rounded-lg bg-white text-center font-semibold hover:bg-blue-50">CASH</button>
                    <button data-method="Credit Card" class="payment-method-btn flex-1 p-3 border rounded-lg bg-white text-center font-semibold hover:bg-blue-50">Credit Card</button>
                    <button data-method="Dana" class="payment-method-btn flex-1 p-3 border rounded-lg bg-white text-center font-semibold hover:bg-blue-50">Dana</button>
                    <button data-method="Debit Card" class="payment-method-btn flex-1 p-3 border rounded-lg bg-white text-center font-semibold hover:bg-blue-50">Debit Card</button>
                    <button data-method="GoPay" class="payment-method-btn flex-1 p-3 border rounded-lg bg-white text-center font-semibold hover:bg-blue-50">GoPay</button>
                    <button data-method="Ovo" class="payment-method-btn flex-1 p-3 border rounded-lg bg-white text-center font-semibold hover:bg-blue-50">Ovo</button>
                </div>
            </div>
            
            <div class="p-3">
                <p class="text-sm font-semibold mb-2 text-gray-600">Daftar Pembayaran</p>
                <div id="payment-list-container" class="bg-white h-20 rounded-lg border p-2">
                </div>
            </div>
            
            <div class="p-3 space-y-2 text-lg">
                <div class="flex justify-between font-bold">
                    <span>Grand Total :</span>
                    <span id="summary-grand-total" class="text-yellow-600">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Pembayaran :</span>
                    <span id="summary-payment-total">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Sisa :</span>
                    <span id="summary-sisa">0</span>
                </div>
                <hr>
                <div class="flex justify-between font-bold">
                    <span>Kembalian :</span>
                    <span id="summary-kembalian" class="text-green-600">0</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 p-3 bg-gray-200 rounded-b-lg mt-auto">
                <button id="close-payment-modal-btn" class="py-3 font-bold bg-white border rounded-lg">Tutup</button>
                <button id="confirm-payment-btn" class="py-3 font-bold bg-green-500 text-white rounded-lg opacity-50" disabled>Bayar</button>
            </div>
        </div>
        
        <div id="numpad-modal" class="absolute inset-0 bg-black bg-opacity-20 z-60 items-end justify-center hidden">
            <div class="modal-content bg-gray-200 w-full max-w-md rounded-t-2xl shadow-2xl transform translate-y-full">
                <div class="p-4 border-b bg-white rounded-t-2xl">
                    <p id="numpad-method-title" class="font-bold text-center text-lg">CASH</p>
                    <p class="text-center text-gray-600">SISA: <span id="numpad-sisa" class="font-bold">0</span></p>
                </div>

                <div class="p-4">
                    <input type="text" id="numpad-display" readonly class="w-full bg-yellow-100 text-right text-4xl font-bold p-3 rounded-lg border-2 border-gray-300 mb-3" value="0">
                    
                    <div class="flex gap-2">
                        <div class="w-1/2 grid grid-cols-2 gap-2">
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="125000">125</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="130000">130</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="150000">150</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="200000">200</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="+10000">+10</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="+50000">+50</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="+100000">+100</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="sisa">SISA</button>
                        </div>
                        
                        <div class="w-1/2 grid grid-cols-3 gap-2">
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="7">7</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="8">8</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="9">9</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="4">4</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="5">5</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="6">6</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="1">1</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="2">2</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="3">3</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white font-semibold" data-value="clear">C</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-2xl font-bold" data-value="0">0</button>
                            <button class="numpad-btn p-3 rounded-lg bg-white text-xl" data-value="backspace"><i class="fas fa-backspace"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button id="numpad-tutup-btn" class="w-full p-4 rounded-lg bg-white font-bold text-gray-700">Tutup</button>
                        <button id="numpad-simpan-btn" class="w-full p-4 rounded-lg bg-blue-500 text-white font-bold">Simpan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="active-orders-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center hidden">
        <div class="modal-content bg-gray-200 rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95 flex flex-col" style="max-height: 80vh;">
            <div class="p-4 border-b bg-white rounded-t-lg">
                <h3 class="text-xl font-bold text-center">Nota Aktif</h3>
            </div>
            <div id="active-orders-list" class="flex-1 p-3 overflow-y-auto space-y-3">
            </div>
            <div class="p-3 bg-white border-t rounded-b-lg flex justify-between items-center">
                <span class="text-sm font-semibold">Total Trx: <span id="active-orders-trx-count">0</span></span>
                <button id="close-active-orders-btn" class="px-8 py-2 font-bold bg-gray-200 border rounded-lg hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <div id="open-charge-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center hidden p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm transform scale-95 opacity-0">
            <div class="p-5 border-b">
                <h3 class="text-xl font-bold">Tambah Open Charge</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label for="open-charge-name" class="font-semibold text-sm">Nama Item</label>
                    <input type="text" id="open-charge-name" placeholder="Contoh: Rokok, Parkir" class="w-full mt-1 p-2 border rounded-lg">
                </div>
                <div>
                    <label for="open-charge-price" class="font-semibold text-sm">Harga</label>
                    <input type="number" id="open-charge-price" placeholder="Masukkan harga" class="w-full mt-1 p-2 border rounded-lg">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 p-5 bg-gray-100 rounded-b-lg">
                <button id="cancel-open-charge-btn" class="py-2 font-bold bg-white border rounded-lg">Batal</button>
                <button id="confirm-open-charge-btn" class="py-2 font-bold bg-blue-600 text-white rounded-lg">Tambahkan</button>
            </div>
        </div>
    </div>

    <div id="payment-success-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-[60] items-center justify-center hidden p-4">
        <div class="modal-content bg-gray-200 rounded-lg shadow-xl w-full max-w-sm transform scale-95 opacity-0">
            <div class="p-6 text-center">
                <h2 class="text-2xl font-bold text-gray-800">Pembayaran Sukses</h2>
                <div class="w-16 h-16 bg-green-500 rounded-full mx-auto mt-4 mb-5 flex items-center justify-center">
                    <i class="fas fa-check text-white text-3xl"></i>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-left text-sm mb-4">
                    <div class="bg-white p-3 rounded-lg">
                        <label class="text-gray-500">ID Nota</label>
                        <p id="success-nota-id" class="font-bold text-gray-800 break-words">A040925005</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <label class="text-gray-500">Tamu</label>
                        <p id="success-tamu" class="font-bold text-gray-800">Umum</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <label class="text-gray-500">Grand Total</label>
                        <p id="success-grand-total" class="font-bold text-gray-800">35,200</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <label class="text-gray-500">Total Pembayaran</label>
                        <p id="success-total-pembayaran" class="font-bold text-gray-800">100,000</p>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-lg mb-5">
                    <label class="text-gray-500 text-sm">Kembalian</label>
                    <p id="success-kembalian" class="font-bold text-gray-800 text-3xl">64,800</p>
                </div>
                
                <button id="lihat-nota-btn" class="w-full bg-yellow-300 text-gray-800 font-bold py-3 rounded-lg mb-3 flex items-center justify-center gap-4 hover:bg-yellow-400">
                    <span>Lihat Nota</span>
                    <div class="flex items-center gap-2 text-lg">
                        <i class="fas fa-print"></i>
                        <i class="fas fa-envelope"></i>
                        <i class="fab fa-whatsapp"></i>
                    </div>
                </button>
                <button id="close-success-modal-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600">Tutup</button>
            </div>
        </div>
    </div>

    <div id="receipt-detail-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-[70] items-center justify-center hidden p-4">
        <div class="modal-content bg-gray-200 rounded-lg shadow-xl w-full max-w-sm flex flex-col transform scale-95 opacity-0" style="max-height: 90vh;">
            <div class="p-4 flex justify-between items-center border-b bg-white rounded-t-lg">
                <div class="bg-yellow-200 text-yellow-800 font-bold px-4 py-2 rounded">
                    <p id="receipt-id-box" class="text-lg">A005</p>
                    <p id="receipt-id-full-box" class="text-xs">A040925005</p>
                </div>
                <button id="receipt-selesai-btn" class="bg-yellow-200 text-yellow-800 font-bold px-6 py-2 rounded hover:bg-yellow-300">Selesai</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                 <div id="receipt-content-wrapper" class="bg-white p-4 rounded-lg shadow-inner">
                 </div>
            </div>
            
            <div class="p-3 bg-gray-200 border-t rounded-b-lg">
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <button id="receipt-print-btn" class="flex flex-col items-center justify-center bg-white p-3 rounded-lg text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-print text-2xl mb-1"></i>
                        <span class="text-xs font-semibold">Cetak</span>
                    </button>
                    <button id="receipt-email-btn" class="flex flex-col items-center justify-center bg-white p-3 rounded-lg text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-envelope text-2xl mb-1"></i>
                        <span class="text-xs font-semibold">Email</span>
                    </button>
                    <button id="receipt-whatsapp-btn" class="flex flex-col items-center justify-center bg-white p-3 rounded-lg text-gray-700 hover:bg-gray-50">
                        <i class="fab fa-whatsapp text-2xl mb-1"></i>
                        <span class="text-xs font-semibold">WhatsApp</span>
                    </button>
                </div>
                <button id="close-receipt-detail-btn-2" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600">Tutup</button>
            </div>
        </div>
    </div>

    <div id="print-area" class="hidden"></div>


    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyA1Rbp6QZVBYNGnFcAGFnexj8ajQxIC2Kg",
            authDomain: "menu-online-aps.firebaseapp.com",
            projectId: "menu-online-aps",
            storageBucket: "menu-online-aps.firebasestorage.app",
            messagingSenderId: "153926646130",
            appId: "1:153926646130:web:68d76914acee65dca4c5eb",
            measurementId: "G-SSJ1PQVP44"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allMenuItems = [];
        let activeOrders = [];
        let cart = { id: null, items: [], customerName: 'Umum', isTakeAway: false, tableName: 'Tanpa Meja' };
        let tempCartItems = []; 
        let activeOrderInterval;
        let lastSuccessfulOrder = null;

// [DIROMBAK] Data meja dengan info lantai dan posisi untuk denah
const tablesData = [
    // Lantai 1
    { name: '1', floor: 1, top: '23%', left: '83%' }, { name: '2', floor: 1, top: '23%', left: '73%' },
    { name: '3', floor: 1, top: '23%', left: '63%' }, { name: '4', floor: 1, top: '23%', left: '53%' },
    { name: '5', floor: 1, top: '23%', left: '43%' }, { name: '6', floor: 1, top: '23%', left: '33%' },
    { name: '7', floor: 1, top: '23%', left: '23%' }, { name: '8', floor: 1, top: '23%', left: '13%' },
    { name: '9', floor: 1, top: '2%', left: '33%' }, { name: '10', floor: 1, top: '2%', left: '23%' },
    { name: '11', floor: 1, top: '2%', left: '13%' }, { name: '12', floor: 1, top: '2%', left: '3%' },
    { name: '13', floor: 1, top: '44%', left: '3%' }, { name: '14', floor: 1, top: '44%', left: '13%' },
    { name: '15', floor: 1, top: '44%', left: '23%' }, { name: '16', floor: 1, top: '44%', left: '33%' },
    { name: '17', floor: 1, top: '44%', left: '48%' }, { name: '18', floor: 1, top: '44%', left: '58%' },
    { name: '19', floor: 1, top: '70%', left: '48%' }, { name: '20', floor: 1, top: '70%', left: '58%' },
    { name: '21', floor: 1, top: '70%', left: '68%' },
    
    // Lantai 2 (Koordinat diperbarui sesuai denah baru)
    { name: '23', floor: 2, top: '65%', left: '85%' }, { name: '24', floor: 2, top: '65%', left: '77%' },
    { name: '25', floor: 2, top: '65%', left: '69%' }, { name: '26', floor: 2, top: '65%', left: '61%' },
    { name: '27', floor: 2, top: '65%', left: '53%' }, { name: '28', floor: 2, top: '65%', left: '45%' },
    { name: '29', floor: 2, top: '65%', left: '37%' }, { name: '30', floor: 2, top: '65%', left: '29%' },
    { name: '31', floor: 2, top: '65%', left: '21%' }, { name: '32', floor: 2, top: '65%', left: '13%' },
    { name: '33', floor: 2, top: '65%', left: '5%' }, { name: '34', floor: 2, top: '45%', left: '5%' },
];

        
        const tableModalOverlay = document.getElementById('table-modal-overlay');
        const daftarMejaBtn = document.getElementById('daftar-meja-btn');
        const closeTableModalBtn = document.getElementById('close-table-modal-btn');
  const tableListGrid = document.getElementById('table-list-grid');
        const totalMejaText = document.getElementById('total-meja-text');
        const tableNameDisplay = document.getElementById('table-name-display');

        const newOrderModalOverlay = document.getElementById('new-order-modal-overlay');
        const saveNewOrderBtn = document.getElementById('save-new-order-btn');
        const closeNewOrderBtn = document.getElementById('close-new-order-btn');
        const newOrderCustomerInput = document.getElementById('new-order-customer');
        const newOrderDineInBtn = document.getElementById('new-order-dine-in-btn');
        const newOrderTakeAwayBtn = document.getElementById('new-order-take-away-btn');
        const customerNameDisplay = document.getElementById('customer-name-display');

        const paymentSuccessOverlay = document.getElementById('payment-success-overlay');
        const successNotaId = document.getElementById('success-nota-id');
        const successTamu = document.getElementById('success-tamu');
        const successGrandTotal = document.getElementById('success-grand-total');
        const successTotalPembayaran = document.getElementById('success-total-pembayaran');
        const successKembalian = document.getElementById('success-kembalian');
        const lihatNotaBtn = document.getElementById('lihat-nota-btn');
        const closeSuccessModalBtn = document.getElementById('close-success-modal-btn');

        const receiptDetailOverlay = document.getElementById('receipt-detail-overlay');
        const receiptIdBox = document.getElementById('receipt-id-box');
        const receiptIdFullBox = document.getElementById('receipt-id-full-box');
        const receiptContentWrapper = document.getElementById('receipt-content-wrapper');
        const receiptPrintBtn = document.getElementById('receipt-print-btn');
        const receiptEmailBtn = document.getElementById('receipt-email-btn');
        const receiptWhatsappBtn = document.getElementById('receipt-whatsapp-btn');
        const closeReceiptDetailBtn = document.getElementById('close-receipt-detail-btn-2');
        const receiptSelesaiBtn = document.getElementById('receipt-selesai-btn');
        
        const productGrid = document.getElementById('product-grid');
        const categoryFilterContainer = document.getElementById('category-filter-container');
        const orderItemsContainer = document.getElementById('order-items-container');
        const emptyCartMsg = document.getElementById('empty-cart-msg');
        const searchInput = document.getElementById('search-input');
        const payBtn = document.getElementById('pay-btn');
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const totalProdukEl = document.getElementById('total-produk');
        const grandTotalEl = document.getElementById('grand-total');
        const notaIdEl = document.getElementById('nota-id');
        
        const notaBaruBtnPojok = document.getElementById('nota-baru-btn');
        const notaBaruBtnTengah = document.getElementById('nota-baru-tengah-btn'); 
        
        const productModalOverlay = document.getElementById('product-modal-overlay');
        const paymentModalOverlay = document.getElementById('payment-modal-overlay');
        const activeOrdersModalOverlay = document.getElementById('active-orders-modal-overlay');
        const confirmAddProductBtn = document.getElementById('confirm-add-product-btn'); 
        const modalItemCountEl = document.getElementById('modal-item-count'); 
        const modalTotalPriceEl = document.getElementById('modal-total-price'); 
        
        const openChargeModalOverlay = document.getElementById('open-charge-modal-overlay');
        const openChargeBtn = document.getElementById('open-charge-btn');
        const confirmOpenChargeBtn = document.getElementById('confirm-open-charge-btn');
        const cancelOpenChargeBtn = document.getElementById('cancel-open-charge-btn');
        const openChargeNameInput = document.getElementById('open-charge-name');
        const openChargePriceInput = document.getElementById('open-charge-price');
        const tabDaftarMeja = document.getElementById('tab-daftar-meja');
        const tabDenahMeja = document.getElementById('tab-denah-meja');
        const tableListView = document.getElementById('table-list-view');
        const tableLayoutView = document.getElementById('table-layout-view');
        const layoutContainer = document.getElementById('layout-container');
        const tableOrderDetailModalOverlay = document.getElementById('table-order-detail-modal-overlay');
        
        let occupiedTables = [];
        let totalDueForPayment = 0;
        let payments = [];
        let currentPaymentInput = '0';

        const paymentMainModal = document.getElementById('payment-main-modal');
        const paymentNotaIdEl = document.getElementById('payment-nota-id');
        const summaryGrandTotalEl = document.getElementById('summary-grand-total');
        const summaryPaymentTotalEl = document.getElementById('summary-payment-total');
        const summarySisaEl = document.getElementById('summary-sisa');
        const summaryKembalianEl = document.getElementById('summary-kembalian');
        const paymentListContainer = document.getElementById('payment-list-container');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');

        const numpadModal = document.getElementById('numpad-modal');
        const numpadSisaEl = document.getElementById('numpad-sisa');
        const numpadDisplay = document.getElementById('numpad-display');
        const numpadMethodTitle = document.getElementById('numpad-method-title');


// --- LOGIKA BARU: FITUR MEJA CANGGIH ---

function updateOccupiedTables() {
    occupiedTables = activeOrders
        .filter(order => order.tableName && order.tableName !== 'Tanpa Meja')
        .map(order => order.tableName);
}

function renderTableList(filter = 'Semua') {
    tableListGrid.innerHTML = '';
    let filteredData = tablesData;

    if (filter === 'Kosong') {
        filteredData = tablesData.filter(t => !occupiedTables.includes(t.name));
    } else if (filter === 'Terisi') {
        filteredData = tablesData.filter(t => occupiedTables.includes(t.name));
    }

    filteredData.forEach(table => {
        const isOccupied = occupiedTables.includes(table.name);
        const bgColor = isOccupied ? 'bg-orange-200' : 'bg-white';
        const textColor = isOccupied ? 'text-orange-800' : 'text-gray-700';
        const tableBtn = `<button class="table-btn p-3 rounded-lg border font-bold text-lg ${bgColor} ${textColor}" data-table-name="${table.name}">${table.name}</button>`;
        tableListGrid.innerHTML += tableBtn;
    });
}

function renderTableLayout(floor = 1) {
    layoutContainer.style.backgroundImage = `url('denah-lantai-${floor}.png')`;
    layoutContainer.innerHTML = '';
    const tablesOnFloor = tablesData.filter(t => t.floor === floor);

    tablesOnFloor.forEach(table => {
        const isOccupied = occupiedTables.includes(table.name);
        const bgColor = isOccupied ? 'bg-orange-500' : 'bg-green-500';
        const tableEl = document.createElement('button');
        tableEl.className = `table-btn absolute w-10 h-8 rounded ${bgColor} text-white font-bold flex items-center justify-center text-sm shadow-md`;
        tableEl.style.top = table.top;
        tableEl.style.left = table.left;
        tableEl.textContent = table.name;
        tableEl.dataset.tableName = table.name;
        layoutContainer.appendChild(tableEl);
    });
}

function handleTableClick(tableName) {
    const isOccupied = occupiedTables.includes(tableName);
    if (isOccupied) {
        const order = activeOrders.find(o => o.tableName === tableName);
        openOrderDetailModal(order);
    } else {
        cart.tableName = tableName;
        tableNameDisplay.textContent = tableName;
        closeModal(tableModalOverlay);
    }
}

function openOrderDetailModal(order) {
    const modalContent = document.getElementById('detail-meja-content');
    document.getElementById('detail-meja-name').textContent = order.tableName;

    if (!order.items || order.items.length === 0) {
         modalContent.innerHTML = `
            <div class="h-48 flex flex-col justify-center items-center text-gray-500">
                <i class="fas fa-utensils fa-3x"></i>
                <p class="mt-4 font-semibold">Belum ada pesanan :(</p>
            </div>`;
    } else {
        let itemsHTML = order.items.map(item => `<div class="flex justify-between text-left py-1"><p>${item.quantity}x ${item.name}</p> <p>${formatNumber(item.price * item.quantity)}</p></div>`).join('');
        modalContent.innerHTML = `<div class="space-y-1">${itemsHTML}</div> <hr class="my-2"> <div class="flex justify-between font-bold text-lg"><p>Total</p><p>${formatRupiah(order.total)}</p></div>`;
    }

    document.getElementById('detail-meja-tambah-btn').dataset.orderId = order.id;
    document.getElementById('detail-meja-bayar-btn').dataset.orderId = order.id;

    openModal(tableOrderDetailModalOverlay);
}

// Event Listeners untuk Modal Meja
daftarMejaBtn.addEventListener('click', () => {
    updateOccupiedTables();
    renderTableList('Semua');
    openModal(tableModalOverlay);
});

tabDaftarMeja.addEventListener('click', () => {
    tableListView.classList.remove('hidden');
    tableLayoutView.classList.add('hidden');
    tabDaftarMeja.classList.add('border-blue-600', 'text-blue-600');
    tabDenahMeja.classList.remove('border-blue-600', 'text-blue-600');
});

tabDenahMeja.addEventListener('click', () => {
    tableListView.classList.add('hidden');
    tableLayoutView.classList.remove('hidden');
    tabDenahMeja.classList.add('border-blue-600', 'text-blue-600');
    tabDaftarMeja.classList.remove('border-blue-600', 'text-blue-600');
    updateOccupiedTables();
    renderTableLayout(1);
});

tableListView.addEventListener('click', e => {
    if (e.target.classList.contains('table-list-filter-btn')) {
        renderTableList(e.target.dataset.filter);
         document.querySelectorAll('.table-list-filter-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
         e.target.classList.add('bg-blue-600', 'text-white');
    }
});

tableLayoutView.addEventListener('click', e => {
    if (e.target.classList.contains('floor-filter-btn')) {
        renderTableLayout(parseInt(e.target.dataset.floor));
         document.querySelectorAll('.floor-filter-btn').forEach(btn => {btn.classList.remove('bg-blue-600', 'text-white'); btn.classList.add('bg-white')});
         e.target.classList.add('bg-blue-600', 'text-white');
    }
});

tableModalOverlay.addEventListener('click', e => {
    const tableBtn = e.target.closest('.table-btn');
    if(tableBtn) handleTableClick(tableBtn.dataset.tableName);
});

closeTableModalBtn.addEventListener('click', () => closeModal(tableModalOverlay));

// Event Listeners untuk Modal Detail Pesanan
document.getElementById('detail-meja-tutup-btn').addEventListener('click', () => closeModal(tableOrderDetailModalOverlay));

document.getElementById('detail-meja-tambah-btn').addEventListener('click', (e) => {
    const orderId = e.target.dataset.orderId;
    const orderToLoad = activeOrders.find(o => o.id === orderId);
    if (orderToLoad) {
        cart = { ...orderToLoad }; // Salin semua data pesanan
        renderOrder();
        closeModal(tableOrderDetailModalOverlay);
        closeModal(tableModalOverlay);
    }
});

 document.getElementById('detail-meja-bayar-btn').addEventListener('click', (e) => {
    const orderId = e.target.dataset.orderId;
    const orderToLoad = activeOrders.find(o => o.id === orderId);
    if (orderToLoad) {
        cart = { ...orderToLoad };
        renderOrder();
        closeModal(tableOrderDetailModalOverlay);
        closeModal(tableModalOverlay);
        openPaymentModal();
    }
});


        let isNewOrderTakeAway = false;

        notaBaruBtnTengah.addEventListener('click', () => {
            newOrderCustomerInput.value = 'Umum';
            document.getElementById('new-order-pax').value = 1;
            document.getElementById('new-order-notes').value = '';
            isNewOrderTakeAway = false;
            
            newOrderDineInBtn.classList.add('bg-blue-600', 'text-white');
            newOrderDineInBtn.classList.remove('bg-white');
            newOrderTakeAwayBtn.classList.add('bg-white');
            newOrderTakeAwayBtn.classList.remove('bg-blue-600', 'text-white');

            openModal(newOrderModalOverlay);
        });

        notaBaruBtnPojok.addEventListener('click', () => {
             if (cart.items.length > 0) {
                if (confirm('Anda memiliki item di keranjang. Yakin ingin membuat nota baru dan mengosongkan keranjang?')) {
                    clearOrder();
                }
            } else {
                clearOrder();
            }
        });

        closeNewOrderBtn.addEventListener('click', () => {
            closeModal(newOrderModalOverlay);
        });

        saveNewOrderBtn.addEventListener('click', () => {
            clearOrder();
            const customerName = newOrderCustomerInput.value.trim() || 'Umum';
            cart.customerName = customerName;
            cart.isTakeAway = isNewOrderTakeAway;
            customerNameDisplay.textContent = customerName;
            takeAwayToggle.checked = isNewOrderTakeAway;
            takeAwayToggle.dispatchEvent(new Event('change'));
            renderOrder();
            closeModal(newOrderModalOverlay);
        });

        newOrderDineInBtn.addEventListener('click', () => {
            isNewOrderTakeAway = false;
            newOrderDineInBtn.classList.add('bg-blue-600', 'text-white');
            newOrderDineInBtn.classList.remove('bg-white');
            newOrderTakeAwayBtn.classList.add('bg-white');
            newOrderTakeAwayBtn.classList.remove('bg-blue-600', 'text-white');
        });

        newOrderTakeAwayBtn.addEventListener('click', () => {
            isNewOrderTakeAway = true;
            newOrderTakeAwayBtn.classList.add('bg-blue-600', 'text-white');
            newOrderTakeAwayBtn.classList.remove('bg-white');
            newOrderDineInBtn.classList.add('bg-white');
            newOrderDineInBtn.classList.remove('bg-blue-600', 'text-white');
        });
        
        newOrderModalOverlay.addEventListener('click', e => {
            const paxBtn = e.target.closest('.pax-btn');
            if (paxBtn) {
                const change = parseInt(paxBtn.dataset.change);
                const paxInput = document.getElementById('new-order-pax');
                let currentValue = parseInt(paxInput.value);
                if (currentValue + change >= 1) {
                    paxInput.value = currentValue + change;
                }
            }
        });
        
        payBtn.addEventListener('click', () => {
            if (cart.items.length > 0) {
                openPaymentModal();
            } else {
                alert("Keranjang kosong!");
            }
        });
        
        confirmPaymentBtn.addEventListener('click', async () => {
            if (cart.items.length === 0) return;
            
            const { sub, tax, total } = calculateTotals();
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const change = Math.max(0, totalPaid - total);

            const orderData = {
                items: cart.items,
                subtotal: sub,
                tax: tax,
                total: total,
                customerName: cart.customerName,
                isTakeAway: takeAwayToggle.checked,
                payments: payments,
                change: change,
                status: 'Selesai',
                timestamp: serverTimestamp(),
            };

            try {
                let orderId = cart.id;
                if (orderId) {
                    await updateDoc(doc(db, "orders", orderId), orderData);
                } else {
                    const docRef = await addDoc(collection(db, "orders"), orderData);
                    orderId = docRef.id;
                }
                
                lastSuccessfulOrder = { ...orderData, id: orderId };
                
                closeModal(paymentModalOverlay);
                showSuccessModal(lastSuccessfulOrder);

            } catch (e) {
                console.error("Error processing payment: ", e);
                alert("Gagal memproses pembayaran.");
            }
        });
        
        function showSuccessModal(order) {
            const totalPaid = order.payments.reduce((sum, p) => sum + p.amount, 0);
            successNotaId.textContent = order.id.toUpperCase();
            successTamu.textContent = order.customerName;
            successGrandTotal.textContent = formatNumber(order.total);
            successTotalPembayaran.textContent = formatNumber(totalPaid);
            successKembalian.textContent = formatNumber(order.change);
            openModal(paymentSuccessOverlay);
        }

        function renderReceiptToModal(order) {
            receiptIdBox.textContent = order.id.substring(0, 4).toUpperCase();
            receiptIdFullBox.textContent = order.id.toUpperCase();
            
            const receiptHTML = generateReceiptHTML(order);
            receiptContentWrapper.innerHTML = receiptHTML;
            document.getElementById('print-area').innerHTML = receiptHTML;
        }

        function generateReceiptText(order) {
            const date = new Date(order.timestamp?.seconds * 1000 || Date.now());
            let text = `*--- Detail Nota ---*\n\n`;
            text += `Default Store\n`;
            text += `Receipt: ${order.id.toUpperCase()}\n`;
            text += `Date: ${date.toLocaleDateString('id-ID')} Time: ${date.toLocaleTimeString('id-ID')}\n`;
            text += `Cashier: Demo Account\n`;
            text += `Guest: ${order.customerName}\n`;
            text += `--------------------\n`;
            order.items.forEach(item => {
                text += `${item.quantity} ${item.name.padEnd(15)} ${formatNumber(item.price * item.quantity)}\n`;
            });
            text += `--------------------\n`;
            text += `Subtotal: ${formatNumber(order.subtotal)}\n`;
            text += `PB1 (10%): ${formatNumber(order.tax)}\n`;
            text += `*Grand Total: ${formatNumber(order.total)}*\n`;
            text += `--------------------\n`;
            order.payments.forEach(p => {
                text += `${p.method.toUpperCase()}: ${formatNumber(p.amount)}\n`;
            });
            text += `Change: ${formatNumber(order.change)}\n`;
            text += `--------------------\n\n`;
            text += `Terima Kasih\n`;
            text += `Powered by LarisPos.com`;
            return text;
        }

        function generateReceiptHTML(order) {
            const date = new Date(order.timestamp?.seconds * 1000 || Date.now());
            let itemsHtml = order.items.map(item => `
                <tr>
                    <td colspan="3">${item.quantity} ${item.name}</td>
                    <td class="text-right">${formatNumber(item.price * item.quantity)}</td>
                </tr>
            `).join('');
            let paymentsHtml = order.payments.map(p => `
                <tr>
                    <td colspan="3">${p.method.toUpperCase()}</td>
                    <td class="text-right">${formatNumber(p.amount)}</td>
                </tr>
            `).join('');
            
            return `
            <div class="receipt-content">
                <div class="text-center">
                    <strong>Default Store</strong><br>
                </div>
                <hr>
                <p>Date: ${date.toLocaleDateString('id-ID')} &nbsp; Time: ${date.toLocaleTimeString('id-ID')}</p>
                <p>Guest: ${order.customerName} &nbsp; Pax: 1</p>
                <p>Cashier: Demo Account &nbsp; ${order.isTakeAway ? 'Take Away' : 'Dine In'}</p>
                <hr>
                <table class="w-full">
                    <tbody>${itemsHtml}</tbody>
                </table>
                <hr>
                <table class="w-full">
                    <tbody>
                        <tr><td>Subtotal</td><td>:</td><td class="text-right">${formatNumber(order.subtotal)}</td></tr>
                        <tr><td>PB1 (10%)</td><td>:</td><td class="text-right">${formatNumber(order.tax)}</td></tr>
                        <tr><td><strong>Grand Total</strong></td><td>:</td><td class="text-right"><strong>${formatNumber(order.total)}</strong></td></tr>
                    </tbody>
                </table>
                <hr>
                <table class="w-full">
                    <tbody>
                        ${paymentsHtml}
                        <tr><td>Change</td><td>:</td><td class="text-right">${formatNumber(order.change)}</td></tr>
                    </tbody>
                </table>
                <hr>
                <div class="text-center">
                    <p>Terima Kasih</p>
                    <p>Receipt : ${order.id.toUpperCase()}</p>
                    <p>Printed : ${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${date.toLocaleTimeString('id-ID')}</p>
                    <br>
                    <p>Powered by LarisPos.com</p>
                </div>
            </div>
            `;
        }

        lihatNotaBtn.addEventListener('click', () => {
            if (lastSuccessfulOrder) {
                renderReceiptToModal(lastSuccessfulOrder);
                closeModal(paymentSuccessOverlay);
                openModal(receiptDetailOverlay);
            }
        });
        
        closeSuccessModalBtn.addEventListener('click', () => {
            closeModal(paymentSuccessOverlay);
            clearOrder();
        });

        receiptPrintBtn.addEventListener('click', () => { window.print(); });
        
        receiptEmailBtn.addEventListener('click', () => {
            if (!lastSuccessfulOrder) return;
            const receiptText = generateReceiptText(lastSuccessfulOrder);
            const subject = `Nota Pembayaran #${lastSuccessfulOrder.id.toUpperCase()}`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(receiptText)}`;
        });
        
        receiptWhatsappBtn.addEventListener('click', () => {
            if (!lastSuccessfulOrder) return;
            const receiptText = generateReceiptText(lastSuccessfulOrder);
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(receiptText)}`, '_blank');
        });
        
        const closeAndClear = () => {
            closeModal(receiptDetailOverlay);
            clearOrder();
        };

        closeReceiptDetailBtn.addEventListener('click', closeAndClear);
        receiptSelesaiBtn.addEventListener('click', closeAndClear);
        
        function openPaymentModal() {
            const { total } = calculateTotals();
            totalDueForPayment = total;
            payments = [];
            paymentNotaIdEl.textContent = `ID Nota #${cart.id ? cart.id.substring(0, 6).toUpperCase() : 'BARU'}`;
            updatePaymentSummary();
            openModal(paymentModalOverlay);
        }

        function updatePaymentSummary() {
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const sisa = Math.max(0, totalDueForPayment - totalPaid);
            const kembalian = Math.max(0, totalPaid - totalDueForPayment);

            summaryGrandTotalEl.textContent = formatNumber(totalDueForPayment);
            summaryPaymentTotalEl.textContent = formatNumber(totalPaid);
            summarySisaEl.textContent = formatNumber(sisa);
            summaryKembalianEl.textContent = formatNumber(kembalian);

            paymentListContainer.innerHTML = payments.map(p => `
                <div class="text-sm flex justify-between">
                    <span>${p.method}</span>
                    <span class="font-semibold">${formatNumber(p.amount)}</span>
                </div>
            `).join('');
            
            if (sisa === 0) {
                confirmPaymentBtn.disabled = false;
                confirmPaymentBtn.classList.remove('opacity-50');
            } else {
                confirmPaymentBtn.disabled = true;
                confirmPaymentBtn.classList.add('opacity-50');
            }
        }

        function openNumpad(method) {
            numpadMethodTitle.textContent = method;
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const sisa = totalDueForPayment - totalPaid;
            numpadSisaEl.textContent = formatNumber(sisa);
            currentPaymentInput = '0';
            updateNumpadDisplay();
            
            numpadModal.classList.remove('hidden');
            numpadModal.classList.add('flex');
            setTimeout(() => {
                numpadModal.querySelector('.modal-content').classList.remove('translate-y-full');
            }, 10);
        }

        function closeNumpad() {
            numpadModal.querySelector('.modal-content').classList.add('translate-y-full');
            setTimeout(() => {
                numpadModal.classList.add('hidden');
                numpadModal.classList.remove('flex');
            }, 300);
        }

        function updateNumpadDisplay() {
            numpadDisplay.value = formatNumber(parseInt(currentPaymentInput || '0'));
        }

        function handleNumpadInput(value) {
            if (/[0-9]/.test(value)) {
                if (currentPaymentInput === '0') currentPaymentInput = '';
                currentPaymentInput += value;
            } else if (value === 'backspace') {
                currentPaymentInput = currentPaymentInput.slice(0, -1);
                if (currentPaymentInput === '') currentPaymentInput = '0';
            } else if (value === 'clear') {
                currentPaymentInput = '0';
            } else if (value === 'sisa') {
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const sisa = totalDueForPayment - totalPaid;
                currentPaymentInput = sisa.toString();
            } else if (value.startsWith('+')) {
                const amount = parseInt(value.substring(1));
                currentPaymentInput = (parseInt(currentPaymentInput || '0') + amount).toString();
            } else {
                currentPaymentInput = value;
            }
            updateNumpadDisplay();
        }
        
        paymentMainModal.addEventListener('click', e => {
            const methodBtn = e.target.closest('.payment-method-btn');
            if (methodBtn) {
                const method = methodBtn.dataset.method;
                if (method === 'CASH') {
                    openNumpad(method);
                } else {
                    const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                    const sisa = totalDueForPayment - totalPaid;
                    if (sisa > 0) {
                        payments.push({ method: method, amount: sisa });
                        updatePaymentSummary();
                    }
                }
            }
        });

        numpadModal.addEventListener('click', e => {
            const numpadBtn = e.target.closest('.numpad-btn');
            if (numpadBtn) {
                handleNumpadInput(numpadBtn.dataset.value);
            } else if (e.target.closest('#numpad-tutup-btn')) {
                closeNumpad();
            } else if (e.target.closest('#numpad-simpan-btn')) {
                const amount = parseInt(currentPaymentInput || '0');
                if (amount > 0) {
                    payments.push({ method: 'CASH', amount: amount });
                    updatePaymentSummary();
                }
                closeNumpad();
            }
        });

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuBtn = document.getElementById('menu-btn');
        const tanggalKerjaEl = document.getElementById('tanggal-kerja');
        const bukaNotaAktifBtn = document.getElementById('buka-nota-aktif');
        const notaAktifBtn = document.getElementById('nota-aktif-btn');
        const activeOrdersCountBadge = document.getElementById('active-orders-count-badge');
        const takeAwayContainer = document.getElementById('take-away-container');
        const takeAwayToggle = document.getElementById('take-away-toggle');
        const takeAwayText = document.getElementById('take-away-text');
        
        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0);
        const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(num || 0);

        function openSidebar() {
            sidebarOverlay.classList.remove('hidden');
            sidebar.classList.remove('-translate-x-full');
            setTimeout(() => sidebarOverlay.classList.remove('opacity-0'), 10);
        }

        function closeSidebar() {
            sidebarOverlay.classList.add('opacity-0');
            sidebar.classList.add('-translate-x-full');
            setTimeout(() => sidebarOverlay.classList.add('hidden'), 300);
        }
        
        function setTanggalKerja() {
            const today = new Date();
            const options = { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' };
            tanggalKerjaEl.textContent = `Tanggal Kerja : ${today.toLocaleDateString('id-ID', options)}`;
        }

        menuBtn.addEventListener('click', openSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        
        notaAktifBtn.addEventListener('click', () => {
            openModal(activeOrdersModalOverlay);
            renderActiveOrders();
            if (activeOrderInterval) clearInterval(activeOrderInterval);
            activeOrderInterval = setInterval(renderActiveOrders, 60000); 
        });
        
        takeAwayContainer.addEventListener('click', () => {
            takeAwayToggle.checked = !takeAwayToggle.checked;
            takeAwayToggle.dispatchEvent(new Event('change'));
        });
        
        takeAwayToggle.addEventListener('change', () => {
            if (takeAwayToggle.checked) {
                takeAwayText.textContent = 'Take Away';
                takeAwayText.classList.remove('text-slate-300');
            } else {
                takeAwayText.textContent = 'Dine In';
                takeAwayText.classList.add('text-slate-300');
            }
        });

        function renderProductGrid(itemsToRender) {
            productGrid.innerHTML = '';
            if (itemsToRender.length === 0) {
                productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Produk tidak ditemukan.</p>`;
                return;
            }
            itemsToRender.forEach(item => {
                if (!item.isAvailable) return;

                const itemInTempCart = tempCartItems.find(i => i.id === item.id);
                const quantity = itemInTempCart ? itemInTempCart.quantity : 0;

                const card = document.createElement('div');
                card.className = `relative bg-white border rounded-lg shadow-sm flex flex-col p-2 transition-all duration-200 ${quantity > 0 ? 'border-blue-500 ring-2 ring-blue-200' : ''}`;
                card.dataset.id = item.id;
                
                card.innerHTML = `<div class="product-info-area cursor-pointer"><div class="w-full h-24 bg-cover bg-center rounded-md" style="background-image: url('${item.image || 'https://placehold.co/200x200/e2e8f0/64748b?text=Image'}')"></div><div class="flex-grow flex flex-col pt-2"><p class="font-semibold text-sm leading-tight flex-grow">${item.name}</p><p class="font-bold text-blue-600 mt-1">${formatRupiah(item.price)}</p></div></div><div class="quantity-control-area absolute inset-0 bg-black/40 rounded-lg flex items-center justify-center gap-3 ${quantity > 0 ? '' : 'hidden'}"><button class="modal-quantity-btn w-8 h-8 bg-white text-blue-600 rounded-full font-bold text-lg" data-id="${item.id}" data-change="-1">-</button><span class="quantity-display text-white font-bold text-xl">${quantity}</span><button class="modal-quantity-btn w-8 h-8 bg-white text-blue-600 rounded-full font-bold text-lg" data-id="${item.id}" data-change="1">+</button></div>`;
                
                card.querySelector('.product-info-area').addEventListener('click', () => {
                    updateTempCart(item.id, 1);
                });

                productGrid.appendChild(card);
            });
        }
        
        productGrid.addEventListener('click', e => {
            if (e.target.classList.contains('modal-quantity-btn')) {
                const id = e.target.dataset.id;
                const change = parseInt(e.target.dataset.change);
                updateTempCart(id, change);
            }
        });
        
        function updateTempCart(itemId, change) {
            const item = allMenuItems.find(m => m.id === itemId);
            if (!item) return;
            
            let existingItem = tempCartItems.find(i => i.id === itemId);
            if (existingItem) {
                existingItem.quantity += change;
            } else if (change > 0) {
                tempCartItems.push({ id: item.id, name: item.name, price: item.price, quantity: change });
            }

            tempCartItems = tempCartItems.filter(i => i.quantity > 0);
            filterAndRenderProducts();
            updateModalSummary();
        }

        function updateModalSummary() {
            const totalItems = tempCartItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = tempCartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            modalItemCountEl.textContent = formatNumber(totalItems);
            modalTotalPriceEl.textContent = formatRupiah(totalPrice);
        }

        function renderCategoryFilters() {
            const categories = ['Semua', ...new Set(allMenuItems.map(item => item.category))];
            categoryFilterContainer.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-1.5 text-sm font-semibold border rounded-full whitespace-nowrap transition-colors';
                if (cat === 'Semua') btn.classList.add('bg-gray-800', 'text-white');
                btn.textContent = cat;
                btn.dataset.category = cat;
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('#category-filter-container button').forEach(b => b.classList.remove('bg-gray-800', 'text-white'));
                    e.currentTarget.classList.add('bg-gray-800', 'text-white');
                    filterAndRenderProducts();
                });
                categoryFilterContainer.appendChild(btn);
            });
        }
        
        function filterAndRenderProducts() {
            const activeCategory = document.querySelector('#category-filter-container button.bg-gray-800')?.dataset.category || 'Semua';
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = allMenuItems.filter(item => (activeCategory === 'Semua' || item.category === activeCategory) && item.name.toLowerCase().includes(searchTerm));
            renderProductGrid(filtered);
        }
        searchInput.addEventListener('input', filterAndRenderProducts);

        function updateCartItem(itemId, change) {
            const item = cart.items.find(i => i.id === itemId);
            if (!item) return;
            item.quantity += change;
            if (item.quantity <= 0) cart.items = cart.items.filter(i => i.id !== itemId);
            renderOrder();
        }

        function calculateTotals() {
            const sub = cart.items.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const tax = sub * 0.10;
            const total = sub + tax;
            const totalItems = cart.items.reduce((acc, item) => acc + item.quantity, 0);
            return { sub, tax, total, totalItems };
        }

        function renderOrder() {
            emptyCartMsg.style.display = cart.items.length === 0 ? 'flex' : 'none';
            orderItemsContainer.innerHTML = cart.items.length > 0 ? cart.items.map(item => `<div class="grid grid-cols-12 gap-2 px-4 py-3 border-b items-center"><div class="col-span-2 font-medium flex items-center gap-2"><button class="quantity-btn w-5 h-5 bg-gray-200 rounded-full text-xs" data-id="${item.id}" data-change="-1">-</button><span>${item.quantity}</span><button class="quantity-btn w-5 h-5 bg-gray-200 rounded-full text-xs" data-id="${item.id}" data-change="1">+</button></div><div class="col-span-6 font-medium text-sm">${item.name}</div><div class="col-span-4 text-right font-semibold">${formatNumber(item.price * item.quantity)}</div></div>`).join('') : '';
            
            const { total, totalItems } = calculateTotals();
            totalProdukEl.textContent = totalItems;
            grandTotalEl.textContent = formatRupiah(total);
            payBtn.textContent = `Bayar ${formatRupiah(total)}`;
            notaIdEl.textContent = cart.id ? `Nota #${cart.id.substring(0,6).toUpperCase()}` : 'Nota Baru';
            customerNameDisplay.textContent = cart.customerName;
            tableNameDisplay.textContent = cart.tableName;
        }
        
        function clearOrder() {
            cart = { id: null, items: [], customerName: 'Umum', isTakeAway: false, tableName: 'Tanpa Meja' };
            lastSuccessfulOrder = null;
            takeAwayToggle.checked = false;
            takeAwayToggle.dispatchEvent(new Event('change'));
            renderOrder();
        }

        orderItemsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('quantity-btn')) updateCartItem(e.target.dataset.id, parseInt(e.target.dataset.change)); });
        
        cancelBtn.addEventListener('click', async () => {
            if (!cart.id) {
                if (confirm('Yakin membatalkan nota baru ini?')) {
                    clearOrder();
                }
                return;
            }
            if (confirm(`Yakin ingin MENGHAPUS Nota #${cart.id.substring(0,6).toUpperCase()} secara permanen? Tindakan ini tidak dapat diurungkan.`)) {
                try {
                    await deleteDoc(doc(db, "orders", cart.id));
                    alert('Nota berhasil dihapus.');
                    clearOrder();
                } catch (e) {
                    console.error("Gagal menghapus nota: ", e);
                    alert("Terjadi kesalahan saat menghapus nota. Silakan coba lagi.");
                }
            }
        });
        
        const openModal = (overlay) => { 
            overlay.classList.remove('hidden');
            overlay.classList.add('flex'); 
            setTimeout(() => overlay.querySelector('.modal-content')?.classList.remove('scale-95', 'opacity-0'), 10); 
        };
        const closeModal = (overlay) => { 
            overlay.querySelector('.modal-content')?.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                overlay.classList.remove('flex');
                if (overlay === activeOrdersModalOverlay && activeOrderInterval) {
                    clearInterval(activeOrderInterval);
                }
            }, 300); 
        };
        
        document.getElementById('add-product-btn').addEventListener('click', () => {
            tempCartItems = JSON.parse(JSON.stringify(cart.items));
            updateModalSummary();
            filterAndRenderProducts();
            openModal(productModalOverlay);
        });
        
        document.getElementById('close-product-modal-btn').addEventListener('click', () => closeModal(productModalOverlay));
        
        confirmAddProductBtn.addEventListener('click', () => {
            cart.items = tempCartItems;
            renderOrder();
            closeModal(productModalOverlay);
        });
        
        openChargeBtn.addEventListener('click', () => {
            openChargeNameInput.value = '';
            openChargePriceInput.value = '';
            openModal(openChargeModalOverlay);
        });
        
        cancelOpenChargeBtn.addEventListener('click', () => closeModal(openChargeModalOverlay));
        
        confirmOpenChargeBtn.addEventListener('click', () => {
            const name = openChargeNameInput.value.trim();
            const price = parseInt(openChargePriceInput.value);

            if (!name || isNaN(price) || price <= 0) {
                alert('Nama item dan harga valid harus diisi.');
                return;
            }

            const openChargeItem = {
                id: `oc_${Date.now()}`,
                name: name,
                price: price,
                quantity: 1,
            };

            tempCartItems.push(openChargeItem);
            updateModalSummary();
            closeModal(openChargeModalOverlay);
        });

        document.getElementById('close-payment-modal-btn').addEventListener('click', () => closeModal(paymentModalOverlay));
        
        bukaNotaAktifBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(activeOrdersModalOverlay);
            closeSidebar();
        });
        
        document.getElementById('close-active-orders-btn').addEventListener('click', () => closeModal(activeOrdersModalOverlay));

        saveBtn.addEventListener('click', async () => { 
            if (cart.items.length === 0) { alert("Keranjang kosong!"); return; }
            if (!confirm('Simpan nota ini ke Nota Aktif?')) return;
            const { sub, tax, total } = calculateTotals();
            const orderData = {
                items: cart.items, subtotal: sub, tax: total,
                customerName: cart.customerName,
                isTakeAway: takeAwayToggle.checked,
                status: 'Aktif', timestamp: serverTimestamp(),
            };
            try {
                if(cart.id) { await updateDoc(doc(db, "orders", cart.id), orderData); } 
                else { await addDoc(collection(db, "orders"), orderData); }
                alert('Nota berhasil disimpan!');
                clearOrder();
            } catch (e) {
                console.error("Error saving order: ", e);
                alert("Gagal menyimpan nota.");
            }
        });

        function calculateDuration(startDate) {
            if (!startDate) return { text: '...', totalMinutes: 0 };
            const now = new Date();
            const diffMs = now - startDate;
            const totalMinutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            let text = '';
            if (hours > 0) {
                text += `${hours} Jam `;
            }
            text += `${minutes} Menit`;
            return { text, totalMinutes };
        }

        function renderActiveOrders() {
            const listEl = document.getElementById('active-orders-list');
            const trxCountEl = document.getElementById('active-orders-trx-count');
            activeOrdersCountBadge.textContent = activeOrders.length;
            trxCountEl.textContent = activeOrders.length;
            
            if (activeOrders.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 py-10">Tidak ada nota aktif.</p>`;
                return;
            }

            const sortedOrders = [...activeOrders].sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
            listEl.innerHTML = sortedOrders.map(order => {
                const orderDate = order.timestamp?.toDate();
                const { text: durationText, totalMinutes } = calculateDuration(orderDate);
                const durationClass = totalMinutes > 120 ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800';
                const title = order.isTakeAway 
                    ? `Take Away #${order.id.substring(0, 4).toUpperCase()}`
                    : `Nota #${order.id.substring(0, 4).toUpperCase()}`;

                return `
                    <div class="active-order-card bg-white border rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50" data-id="${order.id}">
                        <div class="text-center mb-2">
                            <p class="font-bold text-lg">${title}</p>
                            <p class="text-xs text-gray-500">${order.id}</p>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1 mb-3">
                            <div class="flex justify-between">
                                <span>Tanggal: ${orderDate ? orderDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) : '...'}</span>
                                <span>Jam: ${orderDate ? orderDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '...'}</span>
                            </div>
                            <div>
                                <span>Tamu: ${order.customerName}</span>
                            </div>
                        </div>
                        <div class="text-center mb-2">
                            <span class="inline-block px-3 py-1 text-sm font-semibold rounded-md ${durationClass}">
                                Total Durasi : ${durationText}
                            </span>
                        </div>
                        <div class="text-center font-bold text-xl">
                            <span>Total : ${formatRupiah(order.total)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('active-orders-list').addEventListener('click', (e) => {
            const card = e.target.closest('.active-order-card');
            if(card) {
                const orderId = card.dataset.id;
                const orderToLoad = activeOrders.find(o => o.id === orderId);
                if (orderToLoad) {
                    cart = {
                        id: orderToLoad.id,
                        items: orderToLoad.items,
                        customerName: orderToLoad.customerName,
                        isTakeAway: orderToLoad.isTakeAway
                    };
                    takeAwayToggle.checked = cart.isTakeAway;
                    takeAwayToggle.dispatchEvent(new Event('change'));
                    renderOrder();
                    closeModal(activeOrdersModalOverlay);
                }
            }
        });
        
        onSnapshot(collection(db, "menu"), (snapshot) => {
            allMenuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allMenuItems.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
            filterAndRenderProducts();
            renderCategoryFilters();
        });
        
        onSnapshot(query(collection(db, "orders"), where("status", "==", "Aktif"), orderBy("timestamp", "desc")), (snapshot) => {
            activeOrders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            updateOccupiedTables();
            if (!activeOrdersModalOverlay.classList.contains('hidden')) {
                renderActiveOrders();
            }
            activeOrdersCountBadge.textContent = activeOrders.length;
        }, (error) => {
            console.error("Firebase query error:", error);
            document.getElementById('active-orders-list').innerHTML = `<div class="text-center text-red-500 p-4">Gagal memuat data. Pastikan indeks Firestore sudah benar.</div>`;
        });
        
        renderOrder();
        setTanggalKerja();
    </script>
        <!-- Skrip untuk mendaftarkan Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('Service Worker Admin berhasil didaftarkan:', registration);
                }).catch(error => {
                    console.log('Pendaftaran Service Worker Admin gagal:', error);
                });
            });
        }
    </script>

</body>
</html>
